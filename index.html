<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ProChorder5.0</title>
    <style>
        #drop-indicator {
            /*--ny indikator-*/
            position: absolute;
            width: 2px;
            height: 1.8em;
            /* Lite h√∂gre √§n texten */
            background-color: var(--primary);
            display: none;
            /* Dold som standard */
            pointer-events: none;
            /* St√∂r inte andra musklick */
            z-index: 9999;
        }

        body.is-dragging * {
            cursor: none !important;
        }

        :root {
            --bg: #f4f5f7;
            --surface: #ffffff;
            --text-color: #172b4d;
            --primary: #0052cc;
            --border: #dfe1e6;
            --shadow: 0 1px 1px rgba(9, 30, 66, 0.25), 0 0 1px rgba(9, 30, 66, 0.31);
            --chord-color: var(--primary);
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-serif: "Georgia", "Times New Roman", serif;
            --success-bg: #28a745;
            --danger-bg: #dc3545;
            --button-text-light: #ffffff;
            --primary-bg-hover: rgba(0, 82, 204, 0.1);
            --section-marker-color: var(--danger-bg);
        }

        body.dark-mode {
            --bg: #1d2125;
            --surface: #282d33;
            --text-color: #c1c9d3;
            --primary: #4c9aff;
            --border: #454c54;
            --success-bg: #30c451;
            --danger-bg: #ff5263;
            --button-text-light: #1d2125;
            --chord-color: #ffcb47;
            --primary-bg-hover: rgba(76, 154, 255, 0.15);
            --section-marker-color: #FFFFFF;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg);
            color: var(--text-color);
            margin: 0;
            padding: 0em;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
        }

        .app-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
        }

        .sidebar {
            flex-basis: 280px;
            flex-grow: 1;
            flex-shrink: 0;
            background-color: var(--surface);
            padding: 0.75em;
            border-radius: 8px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 0.6em;
            align-self: flex-start;
            position: sticky;
            top: 0em;
            height: fit-content;
            box-sizing: border-box;
        }

        .sidebar-group {
            display: flex;
            flex-direction: column;
            gap: 0.5em;
        }

        /* FIX: Kombinerade tv√• .sidebar-group-label-regler till en f√∂r tydlighet */
        .sidebar-group-label {
            position: relative;
            cursor: pointer;
            padding: 0.3em 25px 0.3em 0.5em;
            /* Kompakt padding */
            border-radius: 4px;
            transition: background-color 0.2s;
            user-select: none;
            font-size: 0.9em;
            font-weight: 700;
            opacity: 0.8;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-group-label:hover {
            background-color: var(--primary-bg-hover);
        }

        .sidebar-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
            align-items: center;
            /* Vertikal centrering */
        }

        .sidebar-controls.vertical {
            flex-direction: column;
            align-items: stretch;
        }

        .sidebar button,
        .sidebar select,
        .sidebar input[type="range"],
        .sidebar input[type="text"],
        .sidebar input[type="number"] {
            font-family: var(--font-sans);
            font-weight: 600;
            font-size: 0.8em;
            min-width: 40px;
            height: 38px;
            background-color: var(--bg);
            color: var(--text-color);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0 0.8em;
            box-sizing: border-box;
            width: auto;
        }

        .sidebar .sidebar-controls.horizontal>* {
            flex: 1;
        }

        .sidebar button:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .sidebar button:disabled {
            transform: none;
            background-color: var(--border);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .sidebar input[type="text"] {
            height: 38px;
            padding: 0 0.6em;
        }

        .sidebar button.btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
            color: var(--button-text-light);
        }

        .sidebar button.btn-success {
            background-color: var(--success-bg);
            border-color: var(--success-bg);
            color: var(--button-text-light);
        }

        .sidebar button.btn-danger {
            background-color: var(--danger-bg);
            border-color: var(--danger-bg);
            color: var(--button-text-light);
        }

        .sidebar-controls.font-size-control {
            display: flex;
            align-items: center;
            gap: 0.8em;
        }

        .sidebar-controls.font-size-control>span {
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .sidebar-controls.font-size-control>input[type="range"] {
            flex: 1;
            width: auto;
        }

        .main-content {
            flex-basis: 0;
            flex-grow: 999;
            min-width: 60%;
            display: flex;
            flex-direction: column;
            gap: 0.5em;
        }

        .meta-fields {
            display: flex;
            gap: 1em;
            align-items: stretch;
        }

        .meta-fields input {
            padding: 0.75em;
            border: 1px solid var(--border);
            background-color: var(--surface);
            color: var(--text-color);
            font-size: 1.2em;
            font-weight: 700;
            outline: none;
            border-radius: 8px;
            box-sizing: border-box;
            box-shadow: var(--shadow);
        }

        #btn-live-mode {
            font-family: var(--font-sans);
            font-weight: 600;
            font-size: 0.9em;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0 0.8em;
            box-sizing: border-box;
            background-color: var(--primary);
            border: 1px solid var(--primary);
            color: var(--button-text-light);
            margin-right: 0.5em;
            flex-shrink: 0;
        }

        #btn-live-mode:hover {
            transform: translateY(-2px);
        }

        #song-title {
            flex: 3;
        }

        #song-author {
            flex: 2;
            font-size: 1em;
            font-weight: 400;
        }

        #editor {
            background-color: var(--surface);
            border: 1px solid var(--border);
            padding: 2em;
            border-radius: 8px;
            box-shadow: var(--shadow);
            min-height: 75vh;
            height: auto;
            font-family: var(--font-sans);
            line-height: 2.5;
            outline: none;
            font-size: 16px;
            padding-left: 5em;
            box-sizing: border-box;
            /* FIX: Lade till denna h√§r f√∂r b√§sta effekt */
        }

        #editor * {
            font-size: inherit;
            line-height: inherit;
        }

        #editor>div {
            position: relative;
        }

#editor .chord {
    display: inline-block;
    position: relative;
    top: -1.9em;
    height: 0;
    margin: 0;
    padding: 0;
    text-indent: -9999px;
}

/* G√ñR √ÑVEN DENNA REGEL MER SPECIFIK */
#editor .chord-text {
    position: absolute;
    left: 0;
    text-indent: 0;
    display: inline-block;
    font-family: var(--font-sans);
    font-weight: 600;
    font-size: 0.85em;
    color: var(--chord-color);
    line-height: 1.2;
    min-width: 1ch;
    outline: none;
}

        /* Vi beh√∂ver justera :hover lite ocks√• */
        .chord:hover {
            background-color: var(--primary-bg-hover);
            z-index: 10;
        }

        .chord .chord-handle {
            position: absolute;
            /* √ÑNDRING: Justerad f√∂r att passa den mindre paddingen */
            bottom: 0px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 5px;
            background-color: var(--primary);
            border-radius: 3px;
            cursor: grab;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }

        .chord .chord-handle:active {
            cursor: grabbing;
        }


        .chord:hover .chord-handle {
            opacity: 1;
            /* Visa handtaget vid hover */
            pointer-events: auto;
            /* G√∂r handtaget klickbart vid hover */
        }

        .chord .chord-handle:active {
            cursor: grabbing;
            /* √Ñndra muspekare n√§r man drar */
        }

        /* --- SLUT P√Ö NYA REGLER --- */

        .chord:hover {
            background-color: var(--primary-bg-hover);
        }

        .chord.selected::after {
            content: '';
            position: absolute;
            left: -2px;
            right: -2px;
            top: -2px;
            bottom: 0px;
            border-radius: 6px;
            border: 2px dashed rgba(0, 82, 204, 0.25);
            pointer-events: none;
        }

        .chord-text {
            display: inline-block;
            font-family: var(--font-sans);
            font-weight: 600;
            font-size: 0.85em;
            color: var(--chord-color);
            line-height: 1.2;
            min-width: 1ch;
            outline: none;
        }

        .section-marker {
            position: absolute;
            left: -5em;
            top: 0.1em;
            font-family: var(--font-sans);
            font-weight: 500;
            font-size: 0.75em;
            color: var(--section-marker-color);
            background-color: var(--bg);
            padding: -0.5em;
            border-radius: 4px;
            user-select: none;
            cursor: default;
        }

        .custom-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .custom-dialog-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .custom-dialog-box {
            background-color: var(--surface);
            color: var(--text-color);
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            min-width: 300px;
            max-width: 90%;
            transform: scale(0.95);
            transition: transform 0.2s;
        }

        .custom-dialog-overlay.visible .custom-dialog-box {
            transform: scale(1);
        }

        .custom-dialog-box p {
            margin: 0 0 1.5em 0;
            font-size: 1.1em;
        }

        .custom-dialog-box .dialog-buttons {
            display: flex;
            gap: 1em;
            justify-content: center;
            /* FIX: √Ñndrade 'left' till 'center' som √§r korrekt */
        }

        .custom-dialog-box button {
            min-width: 100px;
            height: 38px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .sidebar-group-label::after {
            content: '‚Ä∫';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%) rotate(0deg);
            transition: transform 0.3s ease;
            font-size: 1.5em;
            font-weight: 500;
        }

        .sidebar-group-label.is-open::after {
            transform: translateY(-50%) rotate(90deg);
        }

        .sidebar-group-content {
            max-height: 500px;
            overflow: hidden;
            opacity: 1;
            transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out;
            padding: 0.1em;
            /* Kompakt padding */
        }

        .sidebar-group-content.is-collapsed {
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s cubic-bezier(0, 1, 0, 1), opacity 0.1s;
        }

        /* =============================================================== */
        /* =================== MOBILL√ÑGE OCH UTSKRIFT ==================== */
        /* =============================================================== */

        @media (max-width: 800px) {
            .app-layout {
                flex-direction: column;
            }

            .sidebar {
                position: sticky;
                top: 0em;
                z-index: 100;
                width: 100%;
                flex-basis: auto;
            }

            .main-content {
                position: relative;
                z-index: 1;
            }

            #editor {
                padding-left: 2.2em;
                /* FIX: Korrekt padding f√∂r mobil */
                font-size: 14px;
            }

            #editor .section-marker {
                left: -2em;
                width: 2em;
                height: 100%;
                top: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                background: none;
                padding: 0;
            }

            #editor .section-marker-text {
                display: none;
            }

            .section-marker::before {
                content: attr(data-abbreviation);
                background-color: var(--bg);
                color: var(--section-marker-color);
                padding: 0.2em 0.5em;
                border-radius: 4px;
                font-size: 0.8rem;
                font-weight: 700;
                font-family: var(--font-sans);
                line-height: 1;
            }

            .sidebar-group-content {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .meta-fields {
                flex-direction: column;
            }
        }

        @media (max-width: 600px) {
            #live-controls {
                display: flex;
                flex-wrap: wrap;
                /* Till√•ter att elementen byter rad */
                flex-direction: row;
                align-items: center;
                justify-content: center;
                /* Centrerar inneh√•llet */
                gap: 0.5em;
                padding: 0.8em;
            }

            #live-controls .speed-control {
                flex-basis: 100%;
                /* Tar upp hela bredden */
                order: -1;
                /* Flyttar reglaget visuellt √∂verst */
                display: flex;
                justify-content: center;
                margin-bottom: 0.5em;
                /* L√§gger till lite avst√•nd under reglaget */
            }

            #live-controls .speed-control input[type="range"] {
                max-width: 250px;
                /* Ger reglaget mer utrymme nu n√§r det har en egen rad */
                flex-grow: 1;
            }

            #live-controls .duration-control input[type="number"] {
                width: 45px;
                /* Minskar bredden p√• inmatningsrutorna */
            }
        }

        @media print {
            body {
                background-color: #fff;
                color: #000;
                padding: 0;
                margin: 0;
            }

            .sidebar,
            .meta-fields {
                display: none;
            }

            .container,
            .app-layout,
            .main-content {
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                max-width: 100%;
            }

            #editor {
                --chord-color: #000;
                min-height: 0;
                box-shadow: none;
                border: none;
                padding: 1em;
                padding-left: 5em;
            }

            .section-marker {
                background-color: #eee;
                color: #333;
            }
        }

        #live-view {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg);
            color: var(--text-color);
            z-index: 2000;
            overflow-y: scroll;
            font-family: var(--font-sans);
        }

        body.live-mode-active .app-layout {
            display: none;
        }

        body.live-mode-active #live-view {
            display: block;
        }

        #live-song-content {
            padding: 4rem 2rem 10rem 2rem;
            max-width: 900px;
            margin: 0 auto;
        }

        #live-song-content h1,
        #live-song-content h2 {
            font-family: var(--font-sans);
            text-align: center;
            margin: 0 auto;
            padding: 0;
        }

        #live-song-content h1 {
            font-size: 2.5em;
            margin-bottom: 0.1em;
        }

        #live-song-content h2 {
            font-size: 1.5em;
            font-weight: 400;
            opacity: 0.8;
            margin-bottom: 3em;
        }

        .live-line {
            margin-bottom: 0;
            position: relative;
        }

        .live-section-marker {
            font-family: var(--font-sans);
            font-weight: 700;
            font-size: 1.5em;
            color: var(--section-marker-color);
            margin-bottom: 0.7em;
        }

        .live-line p {
            margin: 0;
            padding: 0;
            line-height: 2.5;
        }

        .live-line .chunk {
            display: inline-block;
            position: relative;
            vertical-align: bottom;
            white-space: pre-wrap;
            min-width: 4ch;
        }

        .live-line .chunk .lyric {
            display: inline-block;
        }

/* KORRIGERA DENNA REGEL F√ñR LIVE-L√ÑGET */
.live-line .chunk .chord {
    position: absolute;
    top: -0.5em;          /* Flyttar upp ackordet */
    left: 0;
    font-family: inherit;
    font-size: 0.9em;
    font-weight: 700;
    color: var(--chord-color);
    line-height: 1.2;     /* G√∂r texten synlig */
    white-space: nowrap;
    user-select: none;
}

        #live-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.06);
            backdrop-filter: blur(6px);
            padding: 0.8em 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1em;
            z-index: 2001;
            border-top: 1px solid var(--border);
        }

        #live-controls button {
            font-family: var(--font-sans);
            font-weight: 600;
            font-size: 1.2em;
            width: 80px;
            height: 46px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-color);
        }

        #live-controls .speed-control {
            display: flex;
            align-items: center;
            gap: 0.5em;
            color: var(--text-color);
        }

        #live-controls input[type="range"] {
            width: 150px;
        }

        #live-controls .duration-control {
            display: flex;
            align-items: center;
            gap: 0.25em;
        }

        #live-controls .duration-control label {
            font-weight: 600;
            margin-right: 0.5em;
        }

        #live-controls .duration-control input[type="number"] {
            width: 55px;
            height: 38px;
            padding: 0 0.5em;
            text-align: center;
            font-weight: 600;
            border-radius: 6px;
            background-color: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-color);
            -moz-appearance: textfield;
        }

        #live-controls .duration-control input[type="number"]::-webkit-outer-spin-button,
        #live-controls .duration-control input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #live-controls .duration-control span {
            font-weight: 600;
            opacity: 0.8;
            margin-right: 0.5em;
        }

        .hidden-file {
            display: none;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="app-layout">

            <aside class="sidebar">

                <div class="sidebar-group">
                    <span class="sidebar-group-label">ACKORDBYGGARE</span>
                    <div class="sidebar-group-content is-collapsed">
                        <div class="sidebar-controls vertical">
                            <div class="sidebar-controls horizontal">
                                <select id="chord-root">
                                    <option value="">Grundton</option>
                                    <option value="A">A</option>
                                    <option value="A#">A#</option>
                                    <option value="Bb">Bb</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="C#">C#</option>
                                    <option value="Db">Db</option>
                                    <option value="D">D</option>
                                    <option value="D#">D#</option>
                                    <option value="Eb">Eb</option>
                                    <option value="E">E</option>
                                    <option value="F">F</option>
                                    <option value="F#">F#</option>
                                    <option value="Gb">Gb</option>
                                    <option value="G">G</option>
                                    <option value="G#">G#</option>
                                    <option value="Ab">Ab</option>
                                </select>
                                <select id="chord-type">
                                    <option value="">Dur</option>
                                    <option value="m">m</option>
                                    <option value="maj">maj</option>
                                    <option value="dim">dim</option>
                                    <option value="aug">aug</option>
                                    <option value="sus2">sus2</option>
                                    <option value="sus4">sus4</option>
                                </select>
                                <select id="chord-extension">
                                    <option value="">‚Äî</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="9">9</option>
                                    <option value="11">11</option>
                                    <option value="13">13</option>
                                    <option value="/A">/A</option>
                                    <option value="/A#">/A#</option>
                                    <option value="/B">/B</option>
                                    <option value="/C">/C</option>
                                    <option value="/C#">/C#</option>
                                    <option value="/D">/D</option>
                                    <option value="/D#">/D#</option>
                                    <option value="/E">/E</option>
                                    <option value="/F">/F</option>
                                    <option value="/F#">/F#</option>
                                    <option value="/G">/G</option>
                                    <option value="/G#">/G#</option>
                                </select>
                            </div>
                            <div class="sidebar-controls horizontal">
                                <button id="btn-insert-built">Infoga</button>
                                <button id="btn-delete-chord" title="Ta bort markerat ackord">Ta bort</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-group">
                    <span class="sidebar-group-label">L√ÖTSTRUKTUR</span>
                    <div class="sidebar-group-content is-collapsed">
                        <div class="sidebar-controls horizontal">
                            <select id="section-type-select">
                                <option value="" disabled selected>V√§lj sektion...</option>
                                <option value="Intro">Intro</option>
                                <option value="Vers">Vers</option>
                                <option value="Refr√§ng">Refr√§ng</option>
                                <option value="Stick">Stick</option>
                                <option value="Bridge">Bridge</option>
                                <option value="Solo">Solo</option>
                                <option value="Outro">Outro</option>
                                <option value="Mellanspel">Mellanspel</option>
                            </select>
                            <button id="btn-insert-section">Infoga</button>
                        </div>
                    </div>
                </div>

                <div class="sidebar-group">
                    <span class="sidebar-group-label">PROJEKTHANTERING</span>
                    <div class="sidebar-group-content is-collapsed">
                        <div class="sidebar-controls vertical">
                            <div class="sidebar-controls horizontal">
                                <button id="btn-rename-project" title="D√∂p om valt projekt">D√∂p om</button>
                                <button id="btn-transpose-up" title="Transponera upp">+1 Halvton</button>
                                <button id="btn-transpose-down" title="Transponera ner">-1 Halvton</button>
                            </div>
                            <div class="sidebar-controls font-size-control">
                                <span>Textstorlek</span>
                                <input type="range" id="font-size-slider" min="12" max="32" value="16">
                            </div>

                            <select id="project-list" title="Ladda projekt"></select>

                            <div class="sidebar-controls horizontal">
                                <button id="btn-new-project" class="btn-primary"
                                    title="Skapa ett nytt tomt projekt">Nytt</button>
                                <button id="btn-save-project" class="btn-success" title="Spara projekt">Spara</button>
                                <button id="btn-delete-project" class="btn-danger" title="Ta bort valt projekt">Ta
                                    bort</button>
                                <button id="btn-delete-all-projects" class="btn-danger"
                                    title="Ta bort ALLA sparade projekt permanent">Rensa allt</button>
                            </div>

                            <div style="display:flex; flex-wrap: wrap; gap:.5em; margin-top:.5em">
                                <button id="btn-export-json" style="flex:1"
                                    title="Exportera den nuvarande l√•ten som en JSON-fil">L√•t JSON</button>
                                <button id="btn-export-all-json" style="flex:1"
                                    title=" alla sparade l√•tar till en enda JSON-fil">Allt JSON</button>
                                <button id="btn-import-json" style="flex:1"
                                    title="Importera en eller flera l√•tar fr√•n en JSON-fil">Imp. JSON</button>
                                <button id="btn-import-url" style="flex:1" title="H√§mta l√•tar fr√•n en fast GitHub URL"
                                    class="btn-primary">1313</button>
                                <input type="file" id="file-import" accept="application/json" class="hidden-file">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-group">
                    <span class="sidebar-group-label">EXPORT/TEMA</span>
                    <div class="sidebar-group-content is-collapsed">
                        <div class="sidebar-controls horizontal">
                            <button id="btn-export-pdf" title="Exportera som PDF">PDF</button>
                            <button id="btn-export-txt" title="Exportera som TXT">TXT</button>
                            <button id="btn-export-zip" title="Spara alla l√•tar som ZIP">ZIP</button>
                            <button id="btn-toggle-dark-mode" title="V√§xla m√∂rkt/ljust l√§ge">üåô</button>
                        </div>
                    </div>
                </div>

            </aside>

            <main class="main-content">
                <div class="meta-fields">
                    <button id="btn-live-mode" class="btn-primary"
                        title="Aktivera live-l√§ge f√∂r uppspelning">LIVE</button>
                    <input type="text" id="song-title" placeholder="L√•ttitel">
                    <input type="text" id="song-author" placeholder="Artist / L√•tskrivare">
                </div>

                <div id="editor" contenteditable="true" spellcheck="false"></div>
            </main>

        </div>
    </div>

    <div id="live-view">
        <div id="live-song-content"></div>
        <div id="live-controls">
            <button id="live-btn-play-pause">‚ñ∂</button>

            <div class="speed-control">
                <span>L√•ngsamt</span>
                <input type="range" id="live-speed-slider" min="0" max="100" value="20">
                <span>Snabbt</span>
            </div>

            <div class="duration-control">
                <label>Speltid:</label>
                <input type="number" id="live-duration-minutes" min="0" max="60" value="4">
                <span>m</span>
                <input type="number" id="live-duration-seconds" min="0" max="59" step="5" value="0">
                <span>s</span>
            </div>

            <button id="live-btn-exit">Avsluta</button>
        </div>
    </div>


    <div id="custom-alert" class="custom-dialog-overlay">
        <div class="custom-dialog-box">
            <p id="custom-alert-message"></p>
            <div class="dialog-buttons">
                <button id="custom-alert-ok" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <div id="custom-confirm" class="custom-dialog-overlay">
        <div class="custom-dialog-box">
            <p id="custom-confirm-message"></p>
            <div class="dialog-buttons">
                <button id="custom-confirm-cancel">Avbryt</button>
                <button id="custom-confirm-ok" class="btn-danger">OK</button>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // *** VIKTIGT: Byt ut denna URL mot din egen giltiga "Raw" GitHub URL! ***
        const SHARED_SONG_LIST_URL = 'https://raw.githubusercontent.com/Gobonkers65/ProChorder/main/songs-backup.json';

        class StableChordEditor {
            static STORAGE_KEYS = {
                PROJECTS: 'stableProjects',
                LAST_PROJECT: 'lastProject',
                DARK_MODE: 'darkMode'
            };

            constructor(editorId) {
                this.editor = document.getElementById(editorId);
                this.titleInput = document.getElementById('song-title');
                this.authorInput = document.getElementById('song-author');
                this.draggedChord = null;

                this.rootSel = document.getElementById('chord-root');
                this.typeSel = document.getElementById('chord-type');
                this.extSel = document.getElementById('chord-extension');
                this.insertBtn = document.getElementById('btn-insert-built');
                this.btnDeleteChord = document.getElementById('btn-delete-chord');

                this.sectionTypeSelect = document.getElementById('section-type-select');
                this.btnInsertSection = document.getElementById('btn-insert-section');

                this.fontSizeSlider = document.getElementById('font-size-slider');
                this.projectList = document.getElementById('project-list');
                this.btnNewProject = document.getElementById('btn-new-project');
                this.btnSaveProject = document.getElementById('btn-save-project');
                this.btnDeleteProject = document.getElementById('btn-delete-project');
                this.btnDeleteAllProjects = document.getElementById('btn-delete-all-projects');
                this.btnRenameProject = document.getElementById('btn-rename-project');
                this.btnTransposeUp = document.getElementById('btn-transpose-up');
                this.btnTransposeDown = document.getElementById('btn-transpose-down');

                this.btnExportPdf = document.getElementById('btn-export-pdf');
                this.btnExportTxt = document.getElementById('btn-export-txt');
                this.btnExportZip = document.getElementById('btn-export-zip');
                this.btnToggleDarkMode = document.getElementById('btn-toggle-dark-mode');

                this.btnExportJson = document.getElementById('btn-export-json');
                this.btnExportAllJson = document.getElementById('btn-export-all-json');
                this.btnImportJson = document.getElementById('btn-import-json');
                this.fileImport = document.getElementById('file-import');
                this.btnImportUrl = document.getElementById('btn-import-url');

                this.musicalNotes = ["A", "A#", "B", "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#"];
                this.observer = new MutationObserver(this.handleMutations.bind(this));

                this.btnLiveMode = document.getElementById('btn-live-mode');
                this.liveView = document.getElementById('live-view');
                this.liveSongContent = document.getElementById('live-song-content');
                this.liveBtnPlayPause = document.getElementById('live-btn-play-pause');
                this.liveBtnExit = document.getElementById('live-btn-exit');
                this.liveSpeedSlider = document.getElementById('live-speed-slider');
                this.liveDurationMinutesInput = document.getElementById('live-duration-minutes');
                this.liveDurationSecondsInput = document.getElementById('live-duration-seconds');
                this.dropIndicator = document.createElement('div');     //NYTT//
                this.dropIndicator.id = 'drop-indicator';               //NYTT//
                document.body.appendChild(this.dropIndicator);          //NYTT//

                this.scrollInterval = null;
                this.scrollSpeed = 0.2;
                this.scrollRemainder = 0;

                this.history = [];
                this.historyIndex = -1;
                this.historyMax = 100;

                this.debounceTimer = null;
                this.liveSettingsDebounceTimer = null;

                this.init();
            }

            async deleteAllProjects() {
                const confirmed = await this.showCustomConfirm('√Ñr du helt s√§ker? Detta kommer att radera ALLA sparade l√•tar permanent och g√•r inte att √•ngra.');
                if (confirmed) {
                    localStorage.removeItem(StableChordEditor.STORAGE_KEYS.PROJECTS);
                    localStorage.removeItem(StableChordEditor.STORAGE_KEYS.LAST_PROJECT);
                    this.updateProjectList();
                    this.createNewProject();
                    this.showCustomAlert('Alla projekt har tagits bort.');
                }
            }

            getTotalDurationSeconds() {
                const minutes = parseInt(this.liveDurationMinutesInput.value, 10) || 0;
                const seconds = parseInt(this.liveDurationSecondsInput.value, 10) || 0;
                return (minutes * 60) + seconds;
            }

            updateDurationInputs(totalSeconds) {
                if (totalSeconds && totalSeconds > 0) {
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    this.liveDurationMinutesInput.value = minutes;
                    this.liveDurationSecondsInput.value = seconds;
                } else {
                    this.liveDurationMinutesInput.value = 4;
                    this.liveDurationSecondsInput.value = 0;
                }
            }

            showCustomAlert(message) {
                const dialog = document.getElementById('custom-alert');
                document.getElementById('custom-alert-message').textContent = message;
                dialog.classList.add('visible');

                const okBtn = document.getElementById('custom-alert-ok');
                const close = () => dialog.classList.remove('visible');
                okBtn.onclick = close;
            }

            showCustomConfirm(message) {
                return new Promise(resolve => {
                    const dialog = document.getElementById('custom-confirm');
                    document.getElementById('custom-confirm-message').textContent = message;
                    dialog.classList.add('visible');

                    const okBtn = document.getElementById('custom-confirm-ok');
                    const cancelBtn = document.getElementById('custom-confirm-cancel');

                    const close = (value) => {
                        dialog.classList.remove('visible');
                        resolve(value);
                    };

                    okBtn.onclick = () => close(true);
                    cancelBtn.onclick = () => close(false);
                });
            }

            init() {
                this.applySavedTheme();
                this.setupEventListeners();
                this.startObserver();
                this.loadLastProject();
            }

            applySavedTheme() {
                const isDarkMode = localStorage.getItem(StableChordEditor.STORAGE_KEYS.DARK_MODE) === 'enabled';
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                }
                this.btnToggleDarkMode.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            }

            startObserver() {
                this.observer.observe(this.editor, { childList: true, subtree: true, characterData: true });
            }

            stopObserver() { this.observer.disconnect(); }

            setupEventListeners() {
                const updateInsertButton = () => {
                    let chord = this.rootSel.value || '';
                    if (this.typeSel.value) chord += this.typeSel.value;
                    if (this.extSel.value) chord += this.extSel.value;
                    this.insertBtn.textContent = chord ? `Infoga ${chord}` : 'Infoga';
                };
                [this.rootSel, this.typeSel, this.extSel].forEach(sel => sel.addEventListener('change', updateInsertButton));
                this.insertBtn.addEventListener('click', () => {
                    const chord = (this.rootSel.value || '') + (this.typeSel.value || '') + (this.extSel.value || '');
                    if (!chord) return this.showCustomAlert('V√§lj minst en grundton.');
                    this.insertChordAtCursor(chord);
                    this.recordHistoryDebounced();
                });
                this.btnDeleteChord.addEventListener('click', () => { this.deleteSelectedChord(); this.recordHistoryDebounced(); });

                this.btnInsertSection.addEventListener('click', () => {
                    const sectionType = this.sectionTypeSelect.value;
                    if (sectionType) {
                        this.insertSectionMarker(sectionType);
                        this.recordHistoryDebounced();
                        this.sectionTypeSelect.selectedIndex = 0;
                    } else {
                        this.showCustomAlert('V√§lj en sektionstyp fr√•n rullistan.');
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.chord')) {
                        this.clearChordSelection();
                    }
                });
                this.editor.addEventListener('keydown', this.handleKeyDown.bind(this));
                this.editor.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                    document.execCommand('insertText', false, text);
                });

                this.editor.addEventListener('input', (e) => {
                    if (e.target.classList && e.target.classList.contains('chord-text')) {
                        const chordTextEl = e.target;
                        const parentChordEl = chordTextEl.closest('.chord');
                        if (parentChordEl) {
                            parentChordEl.dataset.chord = chordTextEl.textContent;
                            this.recordHistoryDebounced();
                        }
                    } else {
                        this.recordHistoryDebounced();
                    }
                });

                // Hanterar drag-and-drop f√∂r ackord
                this.editor.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (e.ctrlKey || e.altKey) {
                        e.dataTransfer.dropEffect = 'copy';
                    } else {
                        e.dataTransfer.dropEffect = 'move';
                    }

                    // --- NY LOGIK F√ñR ATT VISA MARK√ñREN ---
                    let range;
                    if (document.caretRangeFromPoint) {
                        range = document.caretRangeFromPoint(e.clientX, e.clientY);
                    } else {
                        // Fallback f√∂r √§ldre webbl√§sare
                        const pos = document.caretPositionFromPoint(e.clientX, e.clientY);
                        if (pos) {
                            range = document.createRange();
                            range.setStart(pos.offsetNode, pos.offset);
                        }
                    }

                    if (range) {
                        const rect = range.getBoundingClientRect();
                        this.dropIndicator.style.display = 'block';
                        // Positionera mark√∂ren vid texten, justera f√∂r sidans scrollning
                        this.dropIndicator.style.left = `${rect.left + window.scrollX}px`;
                        this.dropIndicator.style.top = `${rect.top + window.scrollY}px`;
                    }

                });
                // L√§gg till dessa tv√• nya lyssnare f√∂r att d√∂lja mark√∂ren n√§r draget avslutas
                this.editor.addEventListener('dragleave', () => {
                    this.dropIndicator.style.display = 'none';
                });

                this.editor.addEventListener('drop', (e) => {
                    this.dropIndicator.style.display = 'none';
                    this.handleDrop(e); // Anropa din befintliga drop-hanterare
                });

                
                this.projectList.addEventListener('change', () => {
                    const name = this.projectList.value || '';
                    if (name) this.loadProject(name);
                });
                this.btnNewProject.addEventListener('click', async () => {
                    if (await this.showCustomConfirm('√Ñr du s√§ker? Osparade √§ndringar f√∂rsvinner.')) {
                        this.createNewProject();
                    }
                });
                this.btnSaveProject.addEventListener('click', () => {
                    const name = this.titleInput.value.trim();
                    if (!name) return this.showCustomAlert('Ange en l√•ttitel f√∂r att kunna spara.');
                    this.saveProject(name);
                });
                this.btnDeleteProject.addEventListener('click', async () => {
                    const name = this.projectList.value;
                    if (!name) return this.showCustomAlert('V√§lj ett projekt att ta bort.');
                    if (await this.showCustomConfirm(`Ta bort projekt "${name}"? Detta g√•r inte att √•ngra.`)) {
                        this.deleteProject(name);
                    }
                });

                // FIX: Flyttade denna utanf√∂r den andra knappens event listener
                this.btnDeleteAllProjects.addEventListener('click', () => this.deleteAllProjects());

                this.btnRenameProject.addEventListener('click', async () => {
                    const oldName = this.projectList.value;
                    if (!oldName) {
                        return this.showCustomAlert('V√§lj ett projekt att d√∂pa om.');
                    }
                    const newName = prompt('Ange det nya namnet f√∂r projektet:', oldName);
                    if (newName && newName.trim() !== '' && newName.trim() !== oldName) {
                        if (await this.showCustomConfirm(`D√∂pa om "${oldName}" till "${newName.trim()}"?`)) {
                            this.renameProject(oldName, newName.trim());
                        }
                    }
                });
                this.btnTransposeUp.addEventListener('click', () => this.transpose(1));
                this.btnTransposeDown.addEventListener('click', () => this.transpose(-1));
                this.btnExportPdf.addEventListener('click', () => this.exportPdf());

                this.btnExportPdf.addEventListener('click', () => this.exportPdf());
                this.btnExportTxt.addEventListener('click', () => this.exportTxt());
                this.btnExportZip.addEventListener('click', () => this.exportAllAsZip());
                this.btnToggleDarkMode.addEventListener('click', () => this.toggleDarkMode());

                this.btnLiveMode.addEventListener('click', () => this.toggleLiveMode(true));
                this.liveBtnExit.addEventListener('click', () => this.toggleLiveMode(false));
                this.liveBtnPlayPause.addEventListener('click', () => this.toggleScrolling());

                this.liveSpeedSlider.addEventListener('input', (e) => {
                    this.setScrollSpeed(e.target.value);
                    this.updateDurationFromSpeed();
                    clearTimeout(this.liveSettingsDebounceTimer);
                    this.liveSettingsDebounceTimer = setTimeout(() => this.saveLiveSettings(), 1000);
                });

                const durationChangeHandler = () => {
                    const totalSeconds = this.getTotalDurationSeconds();
                    if (totalSeconds > 0) {
                        this.setScrollForDuration(totalSeconds);
                        clearTimeout(this.liveSettingsDebounceTimer);
                        this.liveSettingsDebounceTimer = setTimeout(() => this.saveLiveSettings(), 1000);
                    }
                };
                this.liveDurationMinutesInput.addEventListener('change', durationChangeHandler);
                this.liveDurationSecondsInput.addEventListener('change', durationChangeHandler);

                this.btnExportJson.addEventListener('click', () => this.exportJson());
                this.btnExportAllJson.addEventListener('click', () => this.exportAllJson());
                this.btnImportJson.addEventListener('click', () => this.fileImport.click());
                this.fileImport.addEventListener('change', (e) => this.importJsonFromFile(e.target.files[0]));

                this.btnImportUrl.addEventListener('click', async () => {
                    const confirmed = await this.showCustomConfirm('Vill du ladda den gemensamma l√•tlistan fr√•n GitHub? Detta kommer att skriva √∂ver lokala l√•tar med samma titel.');
                    if (confirmed) {
                        this.importJsonFromUrl(SHARED_SONG_LIST_URL);
                    }
                });

                document.querySelectorAll('.sidebar-group-label').forEach(label => {
                    label.addEventListener('click', (event) => {
                        const content = event.target.nextElementSibling;
                        if (content && content.classList.contains('sidebar-group-content')) {
                            label.classList.toggle('is-open');
                            content.classList.toggle('is-collapsed');
                        }
                    });
                });

                document.addEventListener('keydown', (e) => {
                    const active = document.activeElement;
                    if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) {
                        if (active === this.editor || active.closest && active.closest('#editor')) {
                        } else {
                            return;
                        }
                    }

                    if (document.body.classList.contains('live-mode-active')) {
                        if (e.key === ' ') {
                            e.preventDefault();
                            this.toggleScrolling();
                            return;
                        }
                        if (e.key === 'Escape') {
                            this.toggleLiveMode(false);
                            return;
                        }
                    }

                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        e.preventDefault();
                        this.undo();
                        return;
                    }
                    if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'Z'))) {
                        e.preventDefault();
                        this.redo();
                        return;
                    }
                });
            }


            handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();

                // F√∂rs√∂k skapa en Range vid drop-koordinaterna
                let range = null;
                if (document.caretRangeFromPoint) {
                    range = document.caretRangeFromPoint(e.clientX, e.clientY);
                } else if (document.caretPositionFromPoint) {
                    const pos = document.caretPositionFromPoint(e.clientX, e.clientY);
                    if (pos) {
                        range = document.createRange();
                        range.setStart(pos.offsetNode, pos.offset);
                        range.collapse(true);
                    }
                }

                // Fallback: placera i slutet av editorn om vi inte fick en giltig range
                if (!range || !this.editor.contains(range.startContainer)) {
                    range = document.createRange();
                    range.selectNodeContents(this.editor);
                    range.collapse(false); // i slutet
                }

                // === NY KOD STARTAR H√ÑR ===
                // Kontrollera om Ctrl-tangenten √§r nedtryckt f√∂r att kopiera
                let chordNode;
                if ((e.ctrlKey || e.altKey) && this.draggedChord) {
                    // KOPIERA: Skapa en helt ny ackord-span
                    const chordText = this.draggedChord.dataset.chord;
                    chordNode = this.createChordSpan(chordText);
                } else {
                    // FLYTTA: Anv√§nd det befintliga ackordet (eller fr√•n extern k√§lla)
                    chordNode = this.draggedChord
                        ? this.draggedChord
                        : this.createChordSpan(e.dataTransfer.getData('text/plain'));
                }

                // Se till att noden √§r synlig innan den s√§tts in
                chordNode.style.display = 'inline-block';
                // === NY KOD SLUTAR H√ÑR ===

                // S√§tt in noden p√• drop-platsen
                range.insertNode(chordNode);

                // Flytta mark√∂ren direkt efter insatt nod
                const sel = window.getSelection();
                sel.removeAllRanges();
                const after = document.createRange();
                after.setStartAfter(chordNode);
                after.collapse(true);
                sel.addRange(after);

                // St√§dning
                this.recordHistoryDebounced();

            }


            toggleDarkMode() {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem(StableChordEditor.STORAGE_KEYS.DARK_MODE, isDarkMode ? 'enabled' : 'disabled');
                this.btnToggleDarkMode.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            }

            handleMutations(mutations) {
                this.stopObserver();
                mutations.forEach(mutation => {
                    if (mutation.type === 'characterData' && mutation.target.parentNode.id !== 'editor') {
                        this.formatNode(mutation.target);
                    } else if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(n => {
                            if (n.nodeType === Node.TEXT_NODE) this.formatNode(n);
                            else if (n.nodeType === Node.ELEMENT_NODE && n.matches && !n.matches('.chord, .chord-text, .section-marker')) {
                                n.childNodes.forEach(c => { if (c.nodeType === Node.TEXT_NODE) this.formatNode(c); });
                            }
                        });
                    }
                });
                this.startObserver();
            }

            formatNode(node) {
                if (!node.textContent.includes('[')) return;

                const text = node.textContent;
                const regex = /\[([^\]]+)\]/g;
                let match;
                const frag = document.createDocumentFragment();
                let lastIndex = 0;
                let replaced = false;

                while ((match = regex.exec(text)) !== null) {
                    replaced = true;
                    const beforeText = text.substring(lastIndex, match.index);
                    if (beforeText) frag.appendChild(document.createTextNode(beforeText));

                    const chord = match[1];
                    const chordSpan = this.createChordSpan(chord);
                    frag.appendChild(chordSpan);

                    lastIndex = regex.lastIndex;
                }

                if (replaced) {
                    const afterText = text.substring(lastIndex);
                    if (afterText) frag.appendChild(document.createTextNode(afterText));
                    node.parentNode.replaceChild(frag, node);
                }
            }
            // ERS√ÑTT HELA FUNKTIONEN MED DENNA KOD
            createChordSpan(chord) {
                const span = document.createElement('span');
                span.className = 'chord';
                span.dataset.chord = chord;

                const chordText = document.createElement('span');
                chordText.className = 'chord-text';
                chordText.textContent = chord;
                chordText.spellcheck = false;
                span.appendChild(chordText);

                const handle = document.createElement('span');
                handle.className = 'chord-handle';
                handle.draggable = true;
                span.appendChild(handle);

                span.addEventListener('click', (e) => {
                    if (e.target === handle) return;
                    e.stopPropagation();
                    this.clearChordSelection();
                    span.classList.add('selected');
                });

                span.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    span.remove();
                    this.recordHistoryDebounced();
                });

                handle.addEventListener('dragstart', (e) => {
                    e.stopPropagation();
                    e.dataTransfer.setData('text/plain', chord);
                    e.dataTransfer.effectAllowed = 'copyMove';
                    this.draggedChord = span;
                    document.body.classList.add('is-dragging');

                    if (e.dataTransfer.setDragImage) {
                        const ghost = document.createElement('span');
                        ghost.textContent = chord;
                        ghost.style.display = 'inline-block';
                        ghost.style.padding = '0.1em 0.4em';
                        ghost.style.borderRadius = '3px';
                        ghost.style.backgroundColor = getComputedStyle(document.body).getPropertyValue('--surface');
                        ghost.style.color = getComputedStyle(document.body).getPropertyValue('--chord-color');
                        ghost.style.fontFamily = 'var(--font-sans)';
                        ghost.style.fontWeight = '600';
                        ghost.style.fontSize = '0.85em';
                        ghost.style.border = '1px solid ' + getComputedStyle(document.body).getPropertyValue('--border');
                        ghost.style.position = 'absolute';
                        ghost.style.top = '-9999px';
                        ghost.style.left = '-9999px';
                        document.body.appendChild(ghost);
                        e.dataTransfer.setDragImage(ghost, 10, 15);
                        setTimeout(() => document.body.removeChild(ghost), 0);
                    }

                    // --- H√ÑR √ÑR √ÑNDRINGEN ---
                    // Kontrollera om det √§r en kopiering. D√∂lj bara originalet om det √§r en flytt.
                    const isCopy = e.ctrlKey || e.altKey;
                    if (!isCopy) {
                        setTimeout(() => { span.style.display = 'none'; }, 0);
                    }
                });

                handle.addEventListener('dragend', (e) => {
                    e.stopPropagation();
                    document.body.classList.remove('is-dragging');
                    if (this.draggedChord && this.draggedChord.parentNode) {
                        this.draggedChord.style.display = 'inline-block';
                    }
                    this.draggedChord = null;
                });

                return span;
            }

            clearChordSelection() {
                this.editor.querySelectorAll('.chord.selected').forEach(s => s.classList.remove('selected'));
            }

            handleKeyDown(e) {
                if (e.key === 'Backspace') {
                    const sel = window.getSelection();
                    if (!sel.rangeCount) return;
                    const range = sel.getRangeAt(0);
                    if (range.collapsed && range.startOffset === 0) {
                        let container = range.startContainer;
                        const prev = container.previousSibling;
                        if (prev && prev.nodeType === Node.ELEMENT_NODE && prev.classList.contains('chord')) {
                            e.preventDefault();
                            prev.remove();
                            this.recordHistoryDebounced();
                        }
                    }
                }
            }

            insertChordAtCursor(chord) {
                const sel = window.getSelection();
                if (!sel.rangeCount || !this.editor.contains(sel.anchorNode)) {
                    return this.showCustomAlert('Placera mark√∂ren i texten d√§r du vill infoga ackordet.');
                }

                const range = sel.getRangeAt(0);
                const chordSpan = this.createChordSpan(chord);
                range.deleteContents();
                range.insertNode(chordSpan);
                range.setStartAfter(chordSpan);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }

            insertSectionMarker(type) {
                const sel = window.getSelection();
                if (!sel.rangeCount || !this.editor.contains(sel.anchorNode)) {
                    return this.showCustomAlert('Placera mark√∂ren p√• den rad d√§r du vill infoga mark√∂ren.');
                }
                let node = sel.anchorNode;
                while (node && node.parentNode !== this.editor) {
                    node = node.parentNode;
                }
                if (!node || node.tagName !== 'DIV') return;

                const existingMarker = node.querySelector('.section-marker');
                if (existingMarker) existingMarker.remove();

                this.insertSectionMarkerInDiv(node, type);
            }

            deleteSelectedChord() {
                const selected = this.editor.querySelector('.chord.selected');
                if (selected) {
                    selected.remove();
                    this.recordHistoryDebounced();
                } else {
                    this.showCustomAlert('Klicka p√• ackordet f√∂r att markera det, och tryck sedan p√• "Ta bort".');
                }
            }

            syncChordData() {
                this.editor.querySelectorAll('.chord-text').forEach(chordTextEl => {
                    const parentChordEl = chordTextEl.closest('.chord');
                    if (parentChordEl) {
                        parentChordEl.dataset.chord = chordTextEl.textContent;
                    }
                });
            }

            getContentAsText() {
                let result = [];
                this.editor.childNodes.forEach(lineDiv => {
                    let lineText = '';

                    const marker = lineDiv.querySelector && lineDiv.querySelector('.section-marker');
                    if (marker) {
                        lineText += `::${marker.dataset.section}::`;
                    }

                    lineDiv.childNodes.forEach(node => {
                        if (node.nodeType === Node.TEXT_NODE) {
                            lineText += node.textContent;
                        } else if (node.classList && node.classList.contains && node.classList.contains('chord')) {
                            lineText += `[${node.dataset.chord}]`;
                        } else if (node.classList && node.classList.contains('section-marker-text')) {

                        }
                    });

                    result.push(lineText);
                });
                return result.join('\n');
            }

            loadContent(text, recordHistory = false) {
                this.stopObserver();
                this.editor.innerHTML = '';
                const lines = text.split('\n');
                lines.forEach(lineText => {
                    const lineDiv = document.createElement('div');

                    let sectionType = null;
                    lineText = lineText.replace(/^::(.*?)::/, (match, type) => {
                        sectionType = type;
                        return '';
                    });
                    if (sectionType) {
                        this.insertSectionMarkerInDiv(lineDiv, sectionType);
                    }

                    if (lineText.trim() === '' && !lineText.includes('[')) {
                        lineDiv.appendChild(document.createElement('br'));
                    } else {
                        let currentPos = 0;
                        lineText.replace(/\[([^\]]+)\]/g, (match, chord, offset) => {
                            lineDiv.appendChild(document.createTextNode(lineText.substring(currentPos, offset)));
                            const chordSpan = this.createChordSpan(chord);
                            lineDiv.appendChild(chordSpan);
                            currentPos = offset + match.length;
                        });
                        lineDiv.appendChild(document.createTextNode(lineText.substring(currentPos)));
                    }
                    this.editor.appendChild(lineDiv);
                });
                this.startObserver();
                if (recordHistory) this.recordHistory();
            }

            insertSectionMarkerInDiv(div, type) {
                const abbreviations = { 'Vers': 'V', 'Refr√§ng': 'R', 'Stick': 'S', 'Intro': 'I', 'Outro': 'O', 'Solo': 'Solo', 'Bridge': 'B', 'Mellanspel': 'M' };
                const markerSpan = document.createElement('span');
                markerSpan.className = 'section-marker';
                markerSpan.dataset.section = type;
                markerSpan.setAttribute('contenteditable', 'false');
                markerSpan.dataset.abbreviation = abbreviations[type] || type.charAt(0);

                const textSpan = document.createElement('span');
                textSpan.className = 'section-marker-text';
                textSpan.textContent = type;
                markerSpan.appendChild(textSpan);

                div.insertBefore(markerSpan, div.firstChild);
            }
// L√ÑGG TILL DENNA NYA HJ√ÑLPFUNKTION PRECIS F√ñRE DIN TRANSPOSE-FUNKTION
_transposeSingleNote(note, steps) {
    const sharpMap = { 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#' };
    // Hanterar b√•de grundtoner (t.ex. "C#") och rena noter (t.ex. "C")
    const match = note.match(/^([A-G](?:#|b)?)/);
    if (!match) return note; // Om det inte √§r en not, returnera som den √§r

    let rootNote = match[0];
    let normalizedNote = rootNote.includes('b') ? (sharpMap[rootNote] || rootNote) : rootNote;
    
    const currentIndex = this.musicalNotes.indexOf(normalizedNote);
    if (currentIndex !== -1) {
        const newIndex = (currentIndex + steps + this.musicalNotes.length) % this.musicalNotes.length;
        const transposedRoot = this.musicalNotes[newIndex];
        // S√§tt tillbaka resten av ackord-typen (t.ex. "m7" i "Am7")
        return transposedRoot + note.substring(rootNote.length);
    }
    return note;
}
           // ERS√ÑTT DIN GAMLA TRANSPOSE-FUNKTION MED DENNA NYA VERSION
transpose(steps) {
    this.syncChordData();
    const text = this.getContentAsText();
    const transposedText = text.replace(/\[([^\]]+)\]/g, (fullMatch, chord) => {
        // Dela upp ackordet vid "/" f√∂r att separera huvudackord och basnot
        const parts = chord.split('/');
        const mainChord = parts[0];
        const bassNote = parts.length > 1 ? parts[1] : null;

        // Transponera huvudackordet med hj√§lp av v√•r nya funktion
        const transposedMainChord = this._transposeSingleNote(mainChord, steps);

        // Om det finns en basnot, transponera den ocks√•
        if (bassNote) {
            const transposedBassNote = this._transposeSingleNote(bassNote, steps);
            return `[${transposedMainChord}/${transposedBassNote}]`;
        } else {
            return `[${transposedMainChord}]`;
        }
    });
    this.loadContent(transposedText, true);
}

            generatePdfForProject(projectData) {
                const { jsPDF } = window.jsPDF ? window.jsPDF : window.jspdf;
                const doc = new jsPDF();
                let y = 20;
                const margin = 15;
                const contentMargin = 20;
                const text = projectData.content || '';
                const MIN_CHORD_SPACING_PDF = 7;

                doc.setFontSize(18).setFont(undefined, 'bold');
                doc.text(projectData.title || 'L√•ttitel', margin, y);
                y += 8;

                doc.setFontSize(12).setFont(undefined, 'normal');
                doc.text(projectData.author || 'Artist', margin, y);
                y += 12;

                const lines = text.split('\n');

                lines.forEach(lineText => {
                    if (y > 280) {
                        doc.addPage();
                        y = 20;
                    }

                    if (lineText.trim() === '') {
                        y += 4;
                        return;
                    }

                    let sectionType = null;
                    lineText = lineText.replace(/^::(.*?)::/, (match, type) => {
                        sectionType = type;
                        return '';
                    });

                    const x = margin + contentMargin;
                    let lastChordXEnd = x;

                    if (sectionType) {
                        doc.setFontSize(9).setFont(undefined, 'bold');
                        doc.setTextColor(100, 100, 100);
                        doc.text(sectionType, margin, y + 0.5);
                    }

                    const currentText = lineText.replace(/\[[^\]]+\]/g, '');
                    const hasChords = /\[[^\]]+\]/.test(lineText);

                    if (hasChords) {
                        doc.setFontSize(9).setFont(undefined, 'bold');
                        doc.setTextColor(0, 82, 204);

                        const parts = lineText.split(/(\[[^\]]+\])/g);
                        let currentTextPos = x;

                        parts.forEach(part => {
                            if (part.startsWith('[') && part.endsWith(']')) {
                                const chord = part.substring(1, part.length - 1);
                                const chordWidth = doc.getTextWidth(chord);
                                const intendedX = currentTextPos;
                                const finalX = Math.max(intendedX, lastChordXEnd + MIN_CHORD_SPACING_PDF);
                                doc.text(chord, finalX, y - 4);
                                lastChordXEnd = finalX + chordWidth;
                            } else {
                                currentTextPos += doc.getTextWidth(part);
                            }
                        });
                    }

                    doc.setFontSize(11).setFont(undefined, 'normal');
                    doc.setTextColor(0);
                    doc.text(currentText, x, y);
                    y += 8;
                });

                return doc.output('blob');
            }

            sanitizeFilename = (name) => name.replace(/[\/\\?%*:|"<>]/g, '-') || 'l√•t';

            exportPdf() {
                this.syncChordData();
                const projectData = {
                    title: this.titleInput.value,
                    author: this.authorInput.value,
                    content: this.getContentAsText()
                };
                const pdfBlob = this.generatePdfForProject(projectData);
                saveAs(pdfBlob, `${this.sanitizeFilename(projectData.title)}.pdf`);
            }

            exportTxt() {
                this.syncChordData();
                const title = this.titleInput.value || 'Titel';
                const author = this.authorInput.value || 'Artist';
                const content = this.getContentAsText();
                const fullText = `${title}\n${author}\n\n${content}`;
                const blob = new Blob([fullText], { type: "text/plain;charset=utf-8" });
                saveAs(blob, `${this.sanitizeFilename(title)}.txt`);
            }

            async exportAllAsZip() {
                this.btnExportZip.textContent = 'Genererar...';
                this.btnExportZip.disabled = true;

                try {
                    const projects = JSON.parse(localStorage.getItem(StableChordEditor.STORAGE_KEYS.PROJECTS)) || {};
                    const projectKeys = Object.keys(projects);

                    if (projectKeys.length === 0) {
                        return this.showCustomAlert('Det finns inga sparade projekt att exportera.');
                    }

                    const zip = new JSZip();
                    for (const key of projectKeys) {
                        const project = projects[key];
                        const pdfBlob = this.generatePdfForProject(project);
                        const filename = `${this.sanitizeFilename(project.title || 'ok√§nd-l√•t')}.pdf`;
                        zip.file(filename, pdfBlob);
                    }

                    const content = await zip.generateAsync({ type: "blob" });
                    saveAs(content, "alla-l√•tar.zip");

                } catch (error) {
                    console.error("Kunde inte skapa ZIP-fil:", error);
                    this.showCustomAlert('Ett fel uppstod n√§r ZIP-filen skulle skapas.');
                } finally {
                    this.btnExportZip.textContent = 'ZIP';
                    this.btnExportZip.disabled = false;
                }
            }

            createNewProject() {
                this.titleInput.value = '';
                this.authorInput.value = '';
                this.loadContent('');
                this.projectList.selectedIndex = 0;
                localStorage.removeItem(StableChordEditor.STORAGE_KEYS.LAST_PROJECT);
                const defaultFontSize = 16;
                this.fontSizeSlider.value = defaultFontSize;
                this.editor.style.fontSize = defaultFontSize + 'px';
                this.titleInput.focus();
                this.recordHistory();
            }

            saveProject(name) {
                this.syncChordData();
                const projects = JSON.parse(localStorage.getItem(StableChordEditor.STORAGE_KEYS.PROJECTS)) || {};
                projects[name] = {
                    title: this.titleInput.value,
                    author: this.authorInput.value,
                    fontSize: this.editor.style.fontSize || (this.fontSizeSlider.value + 'px'),
                    content: this.getContentAsText(),
                    scrollSpeed: this.scrollSpeed,
                    duration: this.getTotalDurationSeconds()
                };
                localStorage.setItem(StableChordEditor.STORAGE_KEYS.PROJECTS, JSON.stringify(projects));
                localStorage.setItem(StableChordEditor.STORAGE_KEYS.LAST_PROJECT, name);
                this.updateProjectList(name);

                const originalText = this.btnSaveProject.textContent;
                this.btnSaveProject.textContent = 'Sparat ‚úì';
                this.btnSaveProject.disabled = true;
                setTimeout(() => {
                    this.btnSaveProject.textContent = originalText;
                    this.btnSaveProject.disabled = false;
                }, 1200);

                this.recordHistory();
            }

            loadProject(name) {
                const projects = JSON.parse(localStorage.getItem(StableChordEditor.STORAGE_KEYS.PROJECTS)) || {};
                if (projects[name]) {
                    const data = projects[name];

                    this.titleInput.value = data.title || '';
                    this.authorInput.value = data.author || '';
                    this.editor.style.fontSize = data.fontSize || (this.fontSizeSlider.value + 'px');
                    const num = parseInt((data.fontSize || '').replace('px', ''), 10);
                    if (!isNaN(num)) this.fontSizeSlider.value = num;
                    this.loadContent(data.content || '');

                    localStorage.setItem(StableChordEditor.STORAGE_KEYS.LAST_PROJECT, name);

                    if (this.projectList.value !== name) {
                        this.projectList.value = name;
                    }

                    if (data.scrollSpeed !== undefined && data.scrollSpeed !== null) {
                        this.scrollSpeed = data.scrollSpeed;
                        try {
                            const percent = Math.round(((this.scrollSpeed - 0.02) / (0.5 - 0.02)) * 100);
                            this.liveSpeedSlider.value = Math.max(0, Math.min(100, percent));
                        } catch (e) {
                            this.liveSpeedSlider.value = 20;
                        }
                    }

                    if (data.duration) {
                        this.updateDurationInputs(data.duration);
                    } else {
                        this.updateDurationFromSpeed();
                    }
                    this.recordHistory();
                }
            }

            deleteProject(name) {
                const projects = JSON.parse(localStorage.getItem(StableChordEditor.STORAGE_KEYS.PROJECTS)) || {};
                if (!projects[name]) return;
                delete projects[name];
                localStorage.setItem(StableChordEditor.STORAGE_KEYS.PROJECTS, JSON.stringify(projects));
                const last = localStorage.getItem(StableChordEditor.STORAGE_KEYS.LAST_PROJECT);
                if (last === name) {
                    localStorage.removeItem(StableChordEditor.STORAGE_KEYS.LAST_PROJECT);
                    this.createNewProject();
                }
                this.updateProjectList();
                this.showCustomAlert(`Projekt "${name}" borttaget.`);
            }

            renameProject(oldName, newName) {
                const projects = JSON.parse(localStorage.getItem(StableChordEditor.STORAGE_KEYS.PROJECTS)) || {};

                if (projects[oldName] && !projects[newName]) {
                    projects[newName] = projects[oldName];
                    projects[newName].title = newName;

                    delete projects[oldName];

                    localStorage.setItem(StableChordEditor.STORAGE_KEYS.PROJECTS, JSON.stringify(projects));

                    const lastProject = localStorage.getItem(StableChordEditor.STORAGE_KEYS.LAST_PROJECT);
                    if (lastProject === oldName) {
                        localStorage.setItem(StableChordEditor.STORAGE_KEYS.LAST_PROJECT, newName);
                    }

                    this.titleInput.value = newName;
                    this.updateProjectList(newName);
                    this.showCustomAlert(`Projektet har d√∂pts om till "${newName}".`);
                } else if (projects[newName]) {
                    this.showCustomAlert(`Ett projekt med namnet "${newName}" finns redan.`);
                } else {
                    this.showCustomAlert(`Kunde inte hitta projektet "${oldName}".`);
                }
            }

            updateProjectList(selectedValue) {
                const list = this.projectList;
                const projects = JSON.parse(localStorage.getItem(StableChordEditor.STORAGE_KEYS.PROJECTS)) || {};
                const currentProjects = Object.keys(projects).sort();

                list.innerHTML = '<option value="">Ladda projekt...</option>';
                currentProjects.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    list.appendChild(option);
                });

                const last = selectedValue || localStorage.getItem(StableChordEditor.STORAGE_KEYS.LAST_PROJECT);
                if (last && currentProjects.includes(last)) {
                    list.value = last;
                } else {
                    list.selectedIndex = 0;
                }
            }

            loadLastProject() {
                this.updateProjectList();
                const last = localStorage.getItem(StableChordEditor.STORAGE_KEYS.LAST_PROJECT);
                if (last) {
                    this.loadProject(last);
                } else {
                    const welcomeText = '::Vers::\nV√§lkommen till redigeraren!\n\n::Refr√§ng::\nSkriv text och infoga ackord med [Am], [G], [C] etc.';
                    this.loadContent(welcomeText);
                }
            }

            toggleLiveMode(enter) {
                if (enter) {
                    this.renderLiveView();
                    document.body.classList.add('live-mode-active');
                    this.liveView.scrollTop = 0;
                } else {
                    this.stopScrolling();
                    document.body.classList.remove('live-mode-active');
                }
            }

            renderLiveView() {
                this.syncChordData();
                const title = this.titleInput.value || 'Ok√§nd L√•t';
                const author = this.authorInput.value || 'Ok√§nd Artist';
                const content = this.getContentAsText();

                this.liveSongContent.innerHTML = '';

                const titleEl = document.createElement('h1');
                titleEl.textContent = title;
                const authorEl = document.createElement('h2');
                authorEl.textContent = author;
                this.liveSongContent.appendChild(titleEl);
                this.liveSongContent.appendChild(authorEl);

                const lines = content.split('\n');
                lines.forEach(lineText => {
                    if (lineText.trim() === '') {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.innerHTML = '&nbsp;';
                        emptyDiv.style.lineHeight = '1';
                        this.liveSongContent.appendChild(emptyDiv);
                        return;

                    }


                    const lineContainer = document.createElement('div');
                    lineContainer.className = 'live-line';

                    let sectionType = null;
                    lineText = lineText.replace(/^::(.*?)::/, (match, type) => {
                        sectionType = type;
                        return '';
                    });
                    if (sectionType) {
                        const markerEl = document.createElement('div');
                        markerEl.className = 'live-section-marker';

                        const textSpan = document.createElement('span');
                        textSpan.className = 'section-marker-text';
                        textSpan.textContent = sectionType;
                        markerEl.appendChild(textSpan);

                        const abbreviations = { 'Vers': 'V', 'Refr√§ng': 'R', 'Stick': 'S', 'Intro': 'I', 'Outro': 'O', 'Solo': 'Solo', 'Bridge': 'B', 'Mellanspel': 'M' };
                        markerEl.dataset.abbreviation = abbreviations[sectionType] || sectionType.charAt(0);
                        lineContainer.appendChild(markerEl);
                    }

                    const contentP = document.createElement('p');
                    const parts = lineText.split(/(\[[^\]]+\])/);

                    for (let i = 0; i < parts.length; i++) {
                        const part = parts[i];
                        if (part.startsWith('[') && part.endsWith(']')) {
                            const chord = part.substring(1, part.length - 1);
                            const chunkSpan = document.createElement('span');
                            chunkSpan.className = 'chunk';

                            const chordSpan = document.createElement('span');
                            chordSpan.className = 'chord';
                            chordSpan.textContent = chord;

                            const lyricSpan = document.createElement('span');
                            lyricSpan.className = 'lyric';
                            lyricSpan.innerHTML = '&nbsp;';

                            let lyricText = '';
                            if (i + 1 < parts.length && !parts[i + 1].startsWith('[')) {
                                lyricText = parts[i + 1];
                                i++;
                            }
                            lyricSpan.textContent = lyricText || '\u00A0';

                            chunkSpan.appendChild(chordSpan);
                            chunkSpan.appendChild(lyricSpan);
                            contentP.appendChild(chunkSpan);

                        } else if (part) {
                            const chunkSpan = document.createElement('span');
                            chunkSpan.className = 'chunk';
                            const lyricSpan = document.createElement('span');
                            lyricSpan.className = 'lyric';
                            lyricSpan.textContent = part;
                            chunkSpan.appendChild(lyricSpan);
                            contentP.appendChild(chunkSpan);
                        }
                    }
                    lineContainer.appendChild(contentP);
                    this.liveSongContent.appendChild(lineContainer);
                });

                const duration = this.getTotalDurationSeconds();
                if (!isNaN(duration) && duration > 0) {
                    this.setScrollForDuration(duration);
                }
            }

            toggleScrolling() {
                if (this.scrollInterval) {
                    this.stopScrolling();
                } else {
                    this.setScrollSpeed(this.liveSpeedSlider.value);
                    this.startScrolling();
                }
            }

            startScrolling() {
                if (this.scrollInterval || this.scrollSpeed <= 0) return;

                this.liveBtnPlayPause.textContent = '‚ùö‚ùö';
                this.scrollRemainder = 0;

                const scroll = () => {
                    this.scrollRemainder += this.scrollSpeed;
                    const move = Math.floor(this.scrollRemainder);

                    if (move > 0) {
                        this.liveView.scrollTop += move;
                        this.scrollRemainder -= move;
                    }

                    if (this.liveView.scrollTop + this.liveView.clientHeight >= this.liveView.scrollHeight) {
                        this.stopScrolling();
                    } else {
                        this.scrollInterval = requestAnimationFrame(scroll);
                    }
                };
                this.scrollInterval = requestAnimationFrame(scroll);
            }

            stopScrolling() {
                if (this.scrollInterval) {
                    cancelAnimationFrame(this.scrollInterval);
                }
                this.scrollInterval = null;
                this.liveBtnPlayPause.textContent = '‚ñ∂';
            }

            setScrollSpeed(value) {
                const MIN_MOVE_SPEED = 0.02;
                const MAX_SPEED = 0.5;
                const val = parseFloat(value);

                if (val === 0) {
                    this.scrollSpeed = 0;
                    return;
                }
                const percentage = val / 100;
                this.scrollSpeed = MIN_MOVE_SPEED + percentage * (MAX_SPEED - MIN_MOVE_SPEED);
            }

            setScrollForDuration(durationSeconds) {
                setTimeout(() => {
                    const scrollHeight = Math.max(1, this.liveSongContent.scrollHeight - this.liveView.clientHeight);
                    if (scrollHeight <= 0) return;

                    const frames = Math.max(1, durationSeconds * 60);
                    this.scrollSpeed = scrollHeight / frames;

                    const MIN = 0.001;
                    const MAX = 5;
                    this.scrollSpeed = Math.max(MIN, Math.min(MAX, this.scrollSpeed));

                    const percent = Math.round(((this.scrollSpeed - 0.02) / (0.5 - 0.02)) * 100);
                    this.liveSpeedSlider.value = Math.max(0, Math.min(100, percent));
                }, 100);
            }

            updateDurationFromSpeed() {
                if (this.scrollSpeed < 0.001) {
                    return;
                }
                const scrollHeight = Math.max(1, this.liveSongContent.scrollHeight - this.liveView.clientHeight);
                if (scrollHeight <= 0) return;

                const durationSeconds = scrollHeight / (this.scrollSpeed * 60);
                this.updateDurationInputs(Math.round(durationSeconds));
            }

            saveLiveSettings() {
                const currentProjectName = this.titleInput.value.trim();
                if (!currentProjectName) return;

                const projects = JSON.parse(localStorage.getItem(StableChordEditor.STORAGE_KEYS.PROJECTS)) || {};
                if (projects[currentProjectName]) {
                    projects[currentProjectName].scrollSpeed = this.scrollSpeed;
                    projects[currentProjectName].duration = this.getTotalDurationSeconds();
                }
                localStorage.setItem(StableChordEditor.STORAGE_KEYS.PROJECTS, JSON.stringify(projects));
            }

            recordHistory() {
                const snapshot = this.getContentAsText();
                if (this.history[this.historyIndex] === snapshot) return;
                this.history = this.history.slice(0, this.historyIndex + 1);
                this.history.push(snapshot);
                if (this.history.length > this.historyMax) this.history.shift();
                this.historyIndex = this.history.length - 1;
            }

            recordHistoryDebounced() {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => this.recordHistory(), 300);
            }

            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    const snapshot = this.history[this.historyIndex];
                    this.loadContent(snapshot, false);
                }
            }

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    const snapshot = this.history[this.historyIndex];
                    this.loadContent(snapshot, false);
                }
            }

            exportJson() {
                this.syncChordData();
                const projectData = {
                    title: this.titleInput.value,
                    author: this.authorInput.value,
                    content: this.getContentAsText(),
                    fontSize: this.editor.style.fontSize,
                    scrollSpeed: this.scrollSpeed,
                    duration: this.getTotalDurationSeconds()
                };
                const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: "application/json" });
                saveAs(blob, `${this.sanitizeFilename(projectData.title)}.json`);
            }

            exportAllJson() {
                try {
                    const projects = JSON.parse(localStorage.getItem(StableChordEditor.STORAGE_KEYS.PROJECTS)) || {};
                    const projectArray = Object.values(projects);

                    if (projectArray.length === 0) {
                        return this.showCustomAlert('Det finns inga sparade projekt att exportera.');
                    }
                    const blob = new Blob([JSON.stringify(projectArray, null, 2)], { type: "application/json" });
                    saveAs(blob, `alla-l√•tar-backup.json`);
                } catch (error) {
                    console.error("Kunde inte exportera alla projekt som JSON:", error);
                    this.showCustomAlert('Ett fel uppstod vid export av JSON-fil.');
                }
            }

            importJsonFromFile(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            const confirmed = await this.showCustomConfirm(`Du √§r p√• v√§g att importera ${data.length} l√•tar. Detta kommer att skriva √∂ver existerande l√•tar med samma titel. Vill du forts√§tta?`);
                            if (confirmed) this.importMultipleProjects(data);
                        } else if (typeof data === 'object' && data !== null && data.title) {
                            this.importSingleProject(data);
                        } else {
                            throw new Error("Ok√§nt JSON-format.");
                        }
                    } catch (err) {
                        console.error("Importfel:", err);
                        this.showCustomAlert('Fel vid inl√§sning av JSON. Kontrollera att filen √§r korrekt formaterad.');
                    } finally {
                        this.fileImport.value = '';
                    }
                };
                reader.readAsText(file);
            }

            async importJsonFromUrl(url) {
                if (!url) {
                    this.showCustomAlert('Ingen URL angiven.');
                    return;
                }

                if (!url.startsWith('https://raw.githubusercontent.com/')) {
                    this.showCustomAlert('Ange en giltig GitHub Raw-URL (den ska b√∂rja med "https://raw.githubusercontent.com/").');
                    return;
                }

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`N√§tverksfel: ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json();

                    if (Array.isArray(data)) {
                        this.importMultipleProjects(data);
                    } else if (typeof data === 'object' && data !== null && data.title) {
                        this.importSingleProject(data);
                    } else {
                        throw new Error("Ok√§nt JSON-format fr√•n URL.");
                    }
                } catch (err) {
                    console.error("Importfel fr√•n URL:", err);
                    this.showCustomAlert(`Fel vid import fr√•n URL. Kontrollera att URL:en √§r korrekt och att filen √§r en giltig JSON-fil. Fel: ${err.message}`);
                }
            }

            importSingleProject(data) {
                this.titleInput.value = data.title || '';
                this.authorInput.value = data.author || '';
                this.editor.style.fontSize = data.fontSize || '16px';
                this.loadContent(data.content || '', true);
                if (data.scrollSpeed) {
                    this.scrollSpeed = data.scrollSpeed;
                    const percent = Math.round(((this.scrollSpeed - 0.02) / (0.5 - 0.02)) * 100);
                    this.liveSpeedSlider.value = Math.max(0, Math.min(100, percent));
                }

                if (data.duration) this.updateDurationInputs(data.duration);
                this.showCustomAlert(`Projektet "${data.title}" importerades.`);
                this.saveProject(data.title);
                this.recordHistory();
            }

            importMultipleProjects(projectsArray) {
                const projects = JSON.parse(localStorage.getItem(StableChordEditor.STORAGE_KEYS.PROJECTS)) || {};
                let importedCount = 0;
                let overwrittenCount = 0;

                for (const project of projectsArray) {
                    if (project && project.title) {
                        if (projects[project.title]) overwrittenCount++;
                        else importedCount++;

                        delete project.darkMode;

                        projects[project.title] = project;
                    }
                }
                localStorage.setItem(StableChordEditor.STORAGE_KEYS.PROJECTS, JSON.stringify(projects));
                this.updateProjectList();
                this.showCustomAlert(`${importedCount} nya l√•tar importerades. ${overwrittenCount} l√•tar uppdaterades.`);

                if (projectsArray.length > 0 && projectsArray[0].title) {
                    this.loadProject(projectsArray[0].title);
                }
            }
        }

        window.addEventListener('load', () => new StableChordEditor('editor'));
    </script>

</body>

</html>
